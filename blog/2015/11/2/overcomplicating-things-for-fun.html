<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/tufte.css" media="screen">
    <title>Overcomplicating Things for Fun — Michael Twomey</title>
  </head>
  <body>
    <article>
      <header>
        <h1>Overcomplicating Things for Fun — Michael Twomey</h1>
        <p>Published 2015-11-2</p>
      </header>
      <section>
      <p>I mentioned in passing I did something fiddly for fun:</p><p>&lt;pre&gt;<br/>  &lt;div class=“sqs-block embed-block sqs-block-embed” data-block-json=“{&amp;quot;hSize&amp;quot;:null,&amp;quot;floatDir&amp;quot;:null,&amp;quot;url&amp;quot;:&amp;quot;https://twitter.com/micktwomey/status/657646471240617984&amp;quot;,&amp;quot;cache_age&amp;quot;:&amp;quot;3153600000&amp;quot;,&amp;quot;height&amp;quot;:null,&amp;quot;version&amp;quot;:&amp;quot;1.0&amp;quot;,&amp;quot;type&amp;quot;:&amp;quot;rich&amp;quot;,&amp;quot;html&amp;quot;:&amp;quot;&amp;lt;blockquote class=\&amp;quot;twitter-tweet\&amp;quot;&amp;gt;&amp;lt;p lang=\&amp;quot;en\&amp;quot; dir=\&amp;quot;ltr\&amp;quot;&amp;gt;I’ve built the world’s most over-complicated thermometer using a &amp;lt;a href=\&amp;quot;https://twitter.com/Raspberry_Pi\&amp;quot;&amp;gt;@Raspberry_Pi&amp;lt;/a&amp;gt; + Sense Hat + Kinesis Firehose + AWS Lambda + &amp;lt;a href=\&amp;quot;https://twitter.com/HostedGraphite\&amp;quot;&amp;gt;@HostedGraphite&amp;lt;/a&amp;gt;&amp;lt;/p&amp;gt;\u2014 Michael Twomey (@micktwomey) &amp;lt;a href=\&amp;quot;https://twitter.com/micktwomey/status/657646471240617984\&amp;quot;&amp;gt;October 23, 2015&amp;lt;/a&amp;gt;&amp;lt;/blockquote&amp;gt;\n&amp;lt;script async=\&amp;quot;\&amp;quot; src=\&amp;quot;//platform.twitter.com/widgets.js\&amp;quot; charset=\&amp;quot;utf-8\&amp;quot;&amp;gt;&amp;lt;/script&amp;gt;&amp;quot;,&amp;quot;width&amp;quot;:550,&amp;quot;authorName&amp;quot;:&amp;quot;Michael Twomey&amp;quot;,&amp;quot;authorUrl&amp;quot;:&amp;quot;https://twitter.com/micktwomey&amp;quot;,&amp;quot;providerName&amp;quot;:&amp;quot;Twitter&amp;quot;,&amp;quot;providerUrl&amp;quot;:&amp;quot;https://twitter.com&amp;quot;,&amp;quot;resolveObject&amp;quot;:&amp;quot;Tweet&amp;quot;,&amp;quot;resolvedBy&amp;quot;:&amp;quot;twitter&amp;quot;,&amp;quot;resolved&amp;quot;:true}” data-block-type=“22” id=“block-yui_3_17_2_1_1446504246348_16147”&gt;<br/> &lt;div class=“sqs-block-content”&gt;<br/>  &lt;blockquote class=“twitter-tweet”&gt;<br/>   &lt;p dir=“ltr” lang=“en”&gt;<br/>    I’ve built the world’s most over-complicated thermometer using a<br/>    &lt;a href=“https://twitter.com/Raspberry_Pi”&gt;<br/>     @Raspberry_Pi<br/>    &lt;/a&gt;<br/>    + Sense Hat + Kinesis Firehose + AWS Lambda +<br/>    &lt;a href=“https://twitter.com/HostedGraphite”&gt;<br/>     @HostedGraphite<br/>    &lt;/a&gt;<br/>   &lt;/p&gt;<br/>   —Michael Twomey (@micktwomey)<br/>   &lt;a href=“https://twitter.com/micktwomey/status/657646471240617984”&gt;<br/>    October 23, 2015<br/>   &lt;/a&gt;<br/>  &lt;/blockquote&gt;<br/>  &lt;script async=“” charset=“utf-8” src=“//platform.twitter.com/widgets.js”&gt;<br/>  &lt;/script&gt;<br/> &lt;/div&gt;<br/>&lt;/div&gt;</p><p>&lt;/pre&gt;</p><p> While that tweet pretty much sums up what I did I thought I’d go into a little bit more detail on how I built a thermometer using only the hardware and software I had immediately to hand: a Raspberry Pi, a Sense Hat, an AWS account and a Hosted Graphite account.</p><p> First, I didn’t  <strong> just</strong> do this for fun, I also wanted to kick the tyres of a couple of new services. I find the best way to evaluate some services is to find a little noddy task you can leave running for weeks and see what it looks like after a while. In this case I wanted to see was what the AWS Kinesis Firehose and Lambda services were like.</p><h1> Recording the Data</h1><p> The first step is recording the data. I used Python 3, the sense_hat module and the <a href="https://boto3.readthedocs.org/"> boto3</a>  library. The latter deserves a special mention, it’s a complete rewrite of Boto using automatically generated code. It tracks the AWS API really closely and seems to be more consistent overall (due to being generated).</p><p>&lt;pre&gt;<br/>  &lt;div class=“sqs-block code-block sqs-block-code” data-block-type=“23” id=“block-yui_3_17_2_1_1446504246348_32685”&gt;<br/> &lt;div class=“sqs-block-content”&gt;<br/>  &lt;script src=“https://gist.github.com/micktwomey/3fe69397255e489e1e2b.js?file=hat_recorder.py”&gt;<br/>  &lt;/script&gt;<br/> &lt;/div&gt;<br/>&lt;/div&gt;</p><p>&lt;/pre&gt;</p><p> I basically loop forever, reading the sensors, stashing to disk and pushing to Firehose.</p><p> An important bug is in this code: I’ve forgotten to append a separator (e.g. \n) to each JSON blob I push to Firehose, they all just run together in the S3 blob. While Firehose won’t break an individual data blob you push, it’s your responsibility to make sure you can split them up :) When I was testing with jq I didn’t notice this as jq handles this just fine (spotting the end of one JSON blob and the start of another). Python’s JSON library wants only one blob per file and gets happy. You can see how I dealt with this later.</p><h1> Configuring Firehose</h1><p> Not too much to say here, I set it to write to a S3 bucket every so often. It just works :)</p><p> If you’re  <em> really</em> curious here’s a dump of the config:</p><p>&lt;pre&gt;<br/>  &lt;div class=“sqs-block code-block sqs-block-code” data-block-type=“23” id=“block-yui_3_17_2_7_1446504246348_10748”&gt;<br/> &lt;div class=“sqs-block-content”&gt;<br/>  &lt;script src=“https://gist.github.com/micktwomey/3fe69397255e489e1e2b.js?file=firehose_delivery_stream_config.json”&gt;<br/>  &lt;/script&gt;<br/> &lt;/div&gt;<br/>&lt;/div&gt;</p><p>&lt;/pre&gt;</p><h1> Processing the S3 Blobs</h1><p> To process a blob I created a Python 2.7 Lambda function. Configuring mostly involved pointing at the bucket and handling all events. Then I uploaded my function as a zip.</p><p> Uploading by hand is annoying so I use a Makefile to upload:</p><p>&lt;pre&gt;<br/>  &lt;div class=“sqs-block code-block sqs-block-code” data-block-type=“23” id=“block-yui_3_17_2_7_1446504246348_18995”&gt;<br/> &lt;div class=“sqs-block-content”&gt;<br/>  &lt;script src=“https://gist.github.com/micktwomey/3fe69397255e489e1e2b.js?file=Makefile”&gt;<br/>  &lt;/script&gt;<br/> &lt;/div&gt;<br/>&lt;/div&gt;</p><p>&lt;/pre&gt;</p><p> So now I can use “make upload” to zip up change and update the Lambda function.</p><p> The code itself:</p><p>&lt;pre&gt;<br/>  &lt;div class=“sqs-block code-block sqs-block-code” data-block-type=“23” id=“block-yui_3_17_2_7_1446504246348_20426”&gt;<br/> &lt;div class=“sqs-block-content”&gt;<br/>  &lt;script src=“https://gist.github.com/micktwomey/3fe69397255e489e1e2b.js?file=lambda_process_data.py”&gt;<br/>  &lt;/script&gt;<br/> &lt;/div&gt;<br/>&lt;/div&gt;</p><p>&lt;/pre&gt;</p><p> Mostly it’s derived from the sample code you get when you create the Lambda function, plus a bit to push to the statsd in Hosted Graphite.</p><p> There are two things to note:</p><ol><li>Python 2.7’s in-memory gzip handling was so annoying I just wrote to disk and read it back again. Python 3 has a neater gzip.decompress function.</li><li>I had to write a little noddy function to spot the JSON blobs and emit for parsing by the json library. This is due to me forgetting a separator earlier :)</li></ol><p> TBH I wish the python json.load function could handle multiple blobs, maybe an iterload which yielded each JSON blob. I know it’s not strictly speaking correct but it’d be handy here :)</p><h1> Hosted Graphite</h1><p> Finally, the code pushes to <a href="https://www.hostedgraphite.com/"> Hosted Graphite</a>  where I graph the results:</p><figure><p><img src="https://images.squarespace-cdn.com/content/v1/5424848de4b080907cee39f0/1446506756378-EZ5MI6THIGZIV66W7D2F/ke17ZwdGBToddI8pDm48kOSqUGro4QPpsbS74tb6wLl7gQa3H78H3Y0txjaiv_0fDoOvxcdMmMKkDsyUqMSsMWxHk725yiiHCCLfrh8O1z4YTzHvnKhyp6Da-NYroOW3ZGjoBKy3azqku80C789l0p3pRYTsvZ6Zt7FvvBFcgjuu7f20Ex7fuUjRb3mNPG-b0gLgSqCY5txkboh-NSvqHw/image-asset.png"/></p><p>Now you know what the humidity and pressure is in the office.</p></figure><h1> Addendum: Hardware</h1><p> Now, you may be wondering how we work in such a sweltering office. Well, really you’ve found a problem with the setup. The Pi itself generates quite a bit of heat (I suspect it’s due to it being a Pi 1 and not a Pi 2, so it might run a bit hotter to get the job done), so what you are really seeing is a measurement of the heat of the Pi plus a bit from the office. That 5℃ shift really does look like a genuine bit of overheating in the office though :)</p><p> Next up: add a cable to the GPIO header to move the sense hat away and get a more realistic measure. Alternatively I might look at measuring the Pi itself and subtracting that.</p><h1> Fun Things I’ve Learned</h1><ol><li>Always use a separator for Firehose data. Rather than \n I’d recommend going all old school and using the <a href="https://en.wikipedia.org/wiki/Delimiter#ASCII_delimited_text"> original ASCII separator</a>  : \x1e. You can even throw in start of record to make sure you can skip corrupted records. Bet you didn’t know about those characters :)</li><li>Firehose itself is super simple to use. I can see myself just throwing lots of crap into there and sorting it out later. It can encrypt data at rest too, so you can log quite a bit in there if you want.</li><li>Lambda is pretty cool about failures. At one point there was a problem talking to Hosted Graphite (or S3), so the Lambda functions kept timing out. For any given S3 PUT Lambda will keep retrying for up to 24 hours. In my case it kept retrying until it worked, so all my data got backfilled correctly. I didn’t even notice from my temperature graphs, it was only when I looked in the Cloudwatch dashboard I realised there had been a problem. Idempotent for the win.</li><li>Firehose and Lambda make for a pretty simple log processing pipeline, with some moderate fault tolerance.</li><li>I didn’t notice it but it’d be nice if there was a way to feed in sensitive vars into your Lambda function. I hope of removed all my keys in my Gist.</li><li>The sense hat + Pi runs hot :)</li></ol><p> The full gist of all the code can be found <a href="https://gist.github.com/micktwomey/3fe69397255e489e1e2b"> here</a>  .</p>
      </section>
      <section>
      The current page is called blog/2015/11/2/overcomplicating-things-for-fun.html.
      The parent is <a href="/blog/index.html">blog/index.html</a>.
      The previous is <a href="/blog/2015/11/3/why-i-like-terraform-its-a-dag-with-state.html">blog/2015/11/3/why-i-like-terraform-its-a-dag-with-state.html</a>.
      The next is <a href="/blog/2014/5/15/ad-blocking-with-etchosts.html">blog/2014/5/15/ad-blocking-with-etchosts.html</a>.
      </section>
    </article>
</body>
</html>