<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/tufte.css" media="screen">
    <title>Mesos & Django (and Aurora and CircleCI too) — Michael Twomey</title>
  </head>
  <body>
    <article>
      <header>
        <h1>Mesos & Django (and Aurora and CircleCI too) — Michael Twomey</h1>
        <p>Published 2015-7-16</p>
      </header>
      <section>
      <p>I gave a <a href="http://www.meetup.com/pythonireland/events/221222978/"> talk at Python Ireland</a>  about using Mesos, Django, Aurora and CircleCI together for deployment bliss. These are some of my notes.</p><p>&lt;pre&gt;<br/>  &lt;div class=“sqs-block embed-block sqs-block-embed” data-block-json=‘{“hSize”:null,“floatDir”:null,“url”:“https://www.slideshare.net/micktwomey/apache-mesosanddjango”,“html”:“&amp;lt;iframe src=\“https://www.slideshare.net/slideshow/embed_code/key/5zpCppr7gu6VwO\” width=\“427\” height=\“356\” frameborder=\“0\” marginwidth=\“0\” marginheight=\“0\” scrolling=\“no\” style=\“border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;\” allowfullscreen&amp;gt; &amp;lt;/iframe&amp;gt; &amp;lt;div style=\“margin-bottom:5px\“&amp;gt; &amp;lt;strong&amp;gt; &amp;lt;a href=\“https://www.slideshare.net/secret/5zpCppr7gu6VwO\” title=\“Mesos &amp;amp; Django (and Aurora and CircleCI)\” target=\“_blank\“&amp;gt;Mesos &amp;amp; Django (and Aurora and CircleCI)&amp;lt;/a&amp;gt; &amp;lt;/strong&amp;gt; from &amp;lt;strong&amp;gt;&amp;lt;a href=\“http://www.slideshare.net/micktwomey\” target=\“_blank\“&amp;gt;Michael Twomey&amp;lt;/a&amp;gt;&amp;lt;/strong&amp;gt; &amp;lt;/div&amp;gt;“,“resolvedBy”:“manual”,“resolved”:true}’ data-block-type=“22” id=“block-yui_3_17_2_4_1436967910125_5005”&gt;<br/> &lt;div class=“sqs-block-content”&gt;<br/>  &lt;iframe allowfullscreen=“” data-embed=“true” frameborder=“0” height=“356” marginheight=“0” marginwidth=“0” scrolling=“no” src=“https://www.slideshare.net/slideshow/embed_code/key/5zpCppr7gu6VwO?wmode=opaque” style=“border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;” width=“427”&gt;<br/>  &lt;/iframe&gt;<br/>  &lt;div style=“margin-bottom:5px”&gt;<br/>   &lt;strong&gt;<br/>    &lt;a href=“https://www.slideshare.net/secret/5zpCppr7gu6VwO” target=“_blank” title=“Mesos &amp;amp; Django (and Aurora and CircleCI)“&gt;<br/>     Mesos &amp;amp; Django (and Aurora and CircleCI)<br/>    &lt;/a&gt;<br/>   &lt;/strong&gt;<br/>   from<br/>   &lt;strong&gt;<br/>    &lt;a href=“http://www.slideshare.net/micktwomey” target=“_blank”&gt;<br/>     Michael Twomey<br/>    &lt;/a&gt;<br/>   &lt;/strong&gt;<br/>  &lt;/div&gt;<br/> &lt;/div&gt;<br/>&lt;/div&gt;</p><p>&lt;/pre&gt;</p><h1> Setting up</h1><p> First follow the <a href="http://aurora.apache.org/documentation/latest/vagrant/"> Aurora Vagrant instructions</a>  to set up Aurora. This gets you a working Zookeeper, Mesos master + slave and Aurora itself. I tried using Ansible to jinny up my own little cluster but that was a little bit too much to get going while trying to understand the Aurora build process at the same time :)</p><p> So the first step was a vagrant up.</p><p> Next I installed a few useful packages:</p><pre>apt-get install python-dev ntp htop unzip</pre><p> Then some useful python stuff:</p><pre>curl https://bootstrap.pypa.io/get-pip.py | sudo python<br/>sudo /usr/local/bin/pip2.7 install -U setuptools pip wheel virtualenv awscli</pre><p> These bits were needed for running my Django app in virtualenvs (one per Mesos container). Normally I’d advocate using nothing from the host machine (so put  <em> everything</em> you need in the slug or use a container), but this is handier for a demo :)</p><h1> The Django Code</h1><p> You can find a trivial Django app I called Acaversity here: <a href="http://'s a"> https://github.com/micktwomey/acaversity</a>  . It’s a really small Django app, the most interesting bit is the <a href="https://github.com/micktwomey/acaversity/blob/master/circle.yml"> circle.yml</a>  .</p><p> This is used to build the app in CircleCI, you can see the latest builds <a href="https://circleci.com/gh/micktwomey/acaversity"> here</a>  .</p><p> The general build process is:</p><ol><li>Pip install and test as normal</li><li>Make a slug directory</li><li>Put all the wheel dependencies in there</li><li>Tar it up</li><li>Upload the slug to S3</li></ol><p> The key missing bit here is some kind of hook which pokes the server controlling the aurora deployment config (more on that later). A really simple approach is to write out a config and upload that, keeping it together with the code (and thus allowing for branching). Then you fetch and run that config.</p><p> The reason I use slugs is the Aurora deployment doesn’t have to know what you are doing, all it needs to know is to untar, run bin/setup.sh and then bin/start.sh. This makes it possible to completely switch around what you are doing to start a process.</p><h1> Aurora</h1><p> Apart from setting up Aurora above the other bit you need is the acaversity.aurora (and S3 keys from me ;)). I have the code below, and <a href="/s/acaversity.aurora"> here</a>  as well.</p><p> To do the deploy you ssh onto the vagrant box with aurora and run something like this to deploy.</p><pre>aurora update start devcluster/www-data/devel/acaversity acaversity.aurora</pre><p> That’s pretty much it, this is most of what I demoed (I plan to keep working on this stack to make a more fully fledged drop in stack people can just use).</p><h2> acaversity.aurora</h2><p>&lt;pre&gt;<br/>  &lt;div class=“sqs-block code-block sqs-block-code” data-block-type=“23” id=“block-yui_3_17_2_9_1437065801913_10268”&gt;<br/> &lt;div class=“sqs-block-content”&gt;<br/>  &lt;script src=“https://gist.github.com/micktwomey/4641d1da1bd1669e2c4b.js? file=acaversity.aurora.py”&gt;<br/>  &lt;/script&gt;<br/> &lt;/div&gt;<br/>&lt;/div&gt;<br/>&lt;/pre&gt;</p>
      </section>
      <section>
      The current page is called blog/2015/7/16/mesos-django-and-aurora-and-circleci-too.html.
      The parent is <a href="/blog/index.html">blog/index.html</a>.
      The previous is <a href="/blog/2015/7/8/a-chain-of-amusing-events.html">blog/2015/7/8/a-chain-of-amusing-events.html</a>.
      The next is <a href="/blog/2015/12/5/elm-workshop.html">blog/2015/12/5/elm-workshop.html</a>.
      </section>
    </article>
</body>
</html>